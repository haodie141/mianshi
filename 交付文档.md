# 交付一：

## 1.核心数据表结构

### 1.1 用户表 (rbac_user)

用户表主键 ID 由 Django 自动递增生成，登录名 username 全局唯一，密码采用 Django 默认的 PBKDF2 加密存储。套餐字段 plan 记录 free 或 pro，用于区分是否 Pro 用户；创建时间取自 date_joined，最后一次登录时间由 last_login 维护，是否超级管理员沿用内置 is_superuser 字段。

### 1.2 角色表 (rbac_role)

角色表主键 ID 自增，角色名 name 唯一；通过多对多字段 permissions 与权限表关联，创建与更新时间可在模型层通过 auto_now_add 与 auto_now 自动写入。

### 1.3 权限表 (rbac_permission)

权限表主键 ID 自增，code 字段保存权限代号（如 case:delete），name 字段供人类阅读；创建与更新时间同样由模型自动维护。当前未设置「是否 Pro」布尔列，免费/Pro 区分通过 code 字符串前缀或角色命名约定实现，后续如需物理字段可平滑追加。

## 2. 关系设计

### 2.1 用户-角色关系

用户与角色关系由 Django 自动生成的中间表 rbac_user_roles 承载，内含 user_id 与 role_id 两外键，可额外增加时间戳字段以记录授权时刻。

### 2.2 角色-权限关系

角色与权限关系表 rbac_role_permissions 亦为 Django 默认中间表，含 role_id 与 permission_id 外键，创建与更新时间可自动记录；「是否 Pro」逻辑目前由权限 code 控制，无需额外编号字段，扩展时可直接在 Permission 模型追加 is_pro 布尔列并迁移。



# 交付二：功能实现描述

## 1. 概述

本系统目前通过Gradio界面实现用户、角色和权限的管理功能，而非传统的RESTful API接口。所有功能均通过Python函数调用Django ORM实现。

## 2. 核心功能实现

### 2.1 用户认证

**Gradio登录界面**

- 功能：用户登录认证
- 实现：调用Django `authenticate()` 函数验证用户名和密码
- 验证成功后：进入主界面，可通过「权限查看」页签获取用户角色和权限信息

> 当前实现：未开放公开注册功能，新用户需管理员在Django Admin或通过`createsuperuser`命令添加。

### 2.2 用户管理

**获取所有用户**

- 功能：获取系统中所有用户列表
- 实现：通过`User.objects.all()`查询所有用户
- 使用位置：Gradio「成员分配」下拉框

**查询用户权限**

- 功能：获取指定用户拥有的所有角色和权限
- 实现：先通过`user.roles.values_list('id', flat=True)`获取用户角色ID，再通过`Permission.objects.filter(role__id__in=role_ids)`查询权限
- 使用位置：Gradio「权限查看」页签

### 2.3 角色管理

**获取所有角色**

- 功能：获取系统中所有角色列表
- 实现：通过`Role.objects.all()`查询所有角色
- 使用位置：Gradio「角色管理」和「成员分配」页签

**创建/更新角色**

- 功能：创建新角色或更新现有角色，并分配权限
- 实现：通过`Role.objects.get_or_create(name=role_name)`获取或创建角色，再通过`role.permissions.set(Permission.objects.filter(code__in=perm_codes))`分配权限
- 使用位置：Gradio「角色管理」页签

### 2.4 用户角色分配

**为用户分配角色**

- 功能：为指定用户分配一个或多个角色
- 实现：通过`user.roles.set(role_objs)`设置用户的角色
- 使用位置：Gradio「成员分配」页签



# 交付三：设计思考

## 3.1 权限系统复杂性理解

- **权限模型**：当前系统采用基于角色的访问控制（RBAC）模型，通过用户、角色和权限三个核心实体及其多对多关系实现权限管理。
- **权限颗粒度**：项目定义了基础权限（如CanAddRole、CanChangeRole、CanDeleteRole），保持了合理的权限颗粒度，避免过粗无法满足精细需求或过细造成管理复杂。
- **用户-角色关系**：通过多对多关系表实现灵活的角色分配，支持一个用户拥有多个角色，符合实际业务场景需求。

## 3.2 边界情况与安全风险应对
- **操作审计**：管理员操作应记录操作日志，以支持问题追溯和责任明确。
- **并发修改处理**：当多个管理员同时修改同一用户的角色或同一角色的权限时，应确保修改不会互相覆盖。
- **权限撤销机制**：管理员身份是相对的，系统支持撤销用户的管理员权限，但需确保至少保留一个超级管理员账号。
- **权限最小化原则**：默认新用户无角色，需明确分配权限，符合最小权限原则。

## 3.3 性能优化考量
- **权限查询优化**：当前实现中，权限查询通过Django ORM的多表关联查询实现，可以考虑增加缓存以减少数据库访问次数。
- **数据库索引**：对用户、角色和权限表之间的关联字段添加索引，提高查询性能。
- **批量操作**：当前Gradio界面已支持多选角色分配，减少多次数据库交互。